<?php
/**
 * Schedule Form Manager
 * Helper functions and validation for schedule form shortcode
 * 
 * @package Clinic_Queue_Management
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Class Clinic_Schedule_Form_Manager
 * Provides helper functions and validation for the schedule form
 */
class Clinic_Schedule_Form_Manager {
    
    /**
     * Generate time options for select dropdown
     * 
     * @param string $default_time Default selected time
     * @return string HTML options
     */
    public static function generate_time_options($default_time = '08:00') {
        $options = '';
        for($h = 0; $h < 24; $h++) { 
            for($m = 0; $m < 60; $m+=30) {
                $time = sprintf('%02d:%02d', $h, $m);
                $selected = ($time === $default_time) ? ' selected' : '';
                $options .= "<option value=\"{$time}\"{$selected}>{$time}</option>";
            }
        }
        return $options;
    }
    
    /**
     * Generate a single day time range HTML
     * 
     * @param string $day_key Day key (e.g., 'sunday')
     * @param string $day_label Day label in Hebrew
     * @param string $default_end Default end time (default: '18:00', except Friday: '16:00')
     * @param string $trash_icon SVG icon for delete button
     * @return string HTML for day time range
     */
    public static function generate_day_time_range($day_key, $day_label, $default_end = '18:00', $trash_icon = '') {
        ob_start();
        ?>
        <div class="day-time-range" data-day="<?php echo esc_attr($day_key); ?>" style="display:none;">
            <div class="time-ranges-list" data-day="<?php echo esc_attr($day_key); ?>">
                <div class="time-range-row">
                    <div class="jet-form-builder__row field-type-select-field is-filled">
                        <div class="jet-form-builder__label">
                            <div class="jet-form-builder__label-text time-label">מ-:</div>
                        </div>
                        <div class="jet-form-builder__field-wrap">
                            <select class="jet-form-builder__field select-field time-select from-time" name="<?php echo esc_attr($day_key); ?>_from_time[]">
                                <?php echo self::generate_time_options('08:00'); ?>
                            </select>
                        </div>
                    </div>
                    <div class="jet-form-builder__row field-type-select-field is-filled">
                        <div class="jet-form-builder__label">
                            <div class="jet-form-builder__label-text time-label">עד-:</div>
                        </div>
                        <div class="jet-form-builder__field-wrap">
                            <select class="jet-form-builder__field select-field time-select to-time" name="<?php echo esc_attr($day_key); ?>_to_time[]">
                                <?php echo self::generate_time_options($default_end); ?>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="remove-time-split-btn" style="display:none;"><?php echo $trash_icon; ?></button>
                </div>
            </div>
            <button type="link" class="add-time-split-btn" data-day="<?php echo esc_attr($day_key); ?>">
                <span>+</span> הוספת פיצול
            </button>
        </div>
        <?php
        return ob_get_clean();
    }
    
    /**
     * Generate treatment duration options
     * 
     * @param int $default_minutes Default selected duration in minutes
     * @return string HTML options
     */
    public static function generate_duration_options($default_minutes = 45) {
        $options = '';
        // 5 minutes to 6 hours in 5-minute increments
        for($minutes = 5; $minutes <= 360; $minutes += 5) {
            $hours = floor($minutes / 60);
            $mins = $minutes % 60;
            if ($hours > 0 && $mins > 0) {
                $label = $hours . ' שעות ו-' . $mins . ' דקות';
            } elseif ($hours > 0) {
                $label = $hours . ' שע' . ($hours == 1 ? 'ה' : 'ות');
            } else {
                $label = $mins . ' דקות';
            }
            $selected = ($minutes == $default_minutes) ? ' selected' : '';
            $options .= "<option value=\"{$minutes}\"{$selected}>{$label}</option>";
        }
        return $options;
    }
    
    /**
     * Get SVG icons array
     * 
     * @return array SVG icons
     */
    public static function get_svg_icons() {
        return array(
            'google_calendar' => '<svg width="73" height="24" viewBox="0 0 73 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_5187_28517)">
                    <path d="M70.7263 14.6682L72.7515 16.0209C72.0942 16.9909 70.5221 18.6552 67.8041 18.6552C64.429 18.6552 61.9155 16.0388 61.9155 12.7103C61.9155 9.16848 64.4557 6.76562 67.52 6.76562C70.602 6.76562 72.1119 9.22177 72.6005 10.5478L72.867 11.2242L64.9265 14.5169C65.5305 15.7095 66.472 16.3146 67.8041 16.3146C69.1365 16.3146 70.0602 15.6561 70.7263 14.6682ZM64.5002 12.5236L69.8027 10.3165C69.5095 9.57791 68.6392 9.05291 67.5998 9.05291C66.2766 9.05291 64.438 10.2276 64.5002 12.5236Z" fill="#FF302F"/>
                    <path d="M58.0874 0.703125H60.6452V18.1103H58.0874V0.703125Z" fill="#20B15A"/>
                    <path d="M54.0549 7.22743H56.5241V17.7999C56.5241 22.1871 53.9394 23.9937 50.884 23.9937C48.0063 23.9937 46.2744 22.0537 45.626 20.4786L47.8908 19.5351C48.2993 20.5051 49.2852 21.6533 50.884 21.6533C52.8468 21.6533 54.0549 20.434 54.0549 18.1559V17.3016H53.9661C53.3798 18.0134 52.2607 18.6541 50.8396 18.6541C47.873 18.6541 45.155 16.0644 45.155 12.7273C45.155 9.37215 47.873 6.75586 50.8396 6.75586C52.2519 6.75586 53.3798 7.38772 53.9661 8.08186H54.0549V7.22743ZM54.2324 12.7273C54.2324 10.627 52.838 9.09629 51.0616 9.09629C49.2674 9.09629 47.7575 10.627 47.7575 12.7273C47.7575 14.8007 49.2674 16.3047 51.0616 16.3047C52.8381 16.3137 54.2325 14.8007 54.2325 12.7273" fill="#3686F7"/>
                    <path d="M31.1128 12.6821C31.1128 16.1084 28.4483 18.6268 25.1797 18.6268C21.9112 18.6268 19.2466 16.0995 19.2466 12.6821C19.2466 9.23809 21.9112 6.72852 25.1797 6.72852C28.4483 6.72852 31.1128 9.23809 31.1128 12.6821ZM28.5193 12.6821C28.5193 10.5464 26.9737 9.0778 25.1797 9.0778C23.3856 9.0778 21.8401 10.5464 21.8401 12.6821C21.8401 14.8001 23.3856 16.2864 25.1797 16.2864C26.9739 16.2864 28.5193 14.8001 28.5193 12.6821Z" fill="#FF302F"/>
                    <path d="M44.0715 12.7103C44.0715 16.1366 41.4069 18.6551 38.1384 18.6551C34.8698 18.6551 32.2053 16.1365 32.2053 12.7103C32.2053 9.26634 34.8698 6.76562 38.1384 6.76562C41.4069 6.76562 44.0715 9.25748 44.0715 12.7103ZM41.469 12.7103C41.469 10.5746 39.9236 9.10605 38.1294 9.10605C36.3352 9.10605 34.7898 10.5746 34.7898 12.7103C34.7898 14.8283 36.3354 16.3146 38.1294 16.3146C39.9325 16.3146 41.469 14.8195 41.469 12.7103Z" fill="#FFBA40"/>
                    <path d="M9.49415 16.0471C5.77258 16.0471 2.85943 13.0391 2.85943 9.31025C2.85943 5.58154 5.77258 2.57354 9.49415 2.57354C11.5015 2.57354 12.9669 3.36554 14.0505 4.38011L15.8359 2.5914C14.326 1.14082 12.3098 0.0371094 9.49415 0.0371094C4.39599 0.0372522 0.105957 4.20225 0.105957 9.31025C0.105957 14.4183 4.39599 18.5834 9.49415 18.5834C12.2476 18.5834 14.326 17.6757 15.9514 15.9848C17.6211 14.3117 18.1362 11.9623 18.1362 10.0578C18.1362 9.46154 18.0652 8.84754 17.9853 8.39368H9.49415V10.8677H15.5427C15.3651 12.4163 14.8766 13.4753 14.1572 14.196C13.2867 15.0771 11.9101 16.0471 9.49415 16.0471Z" fill="#3686F7"/>
                </g>
                <defs>
                    <clipPath id="clip0_5187_28517">
                        <rect width="73" height="24" fill="white"/>
                    </clipPath>
                </defs>
            </svg>',
            
            'clinix_logo' => '<svg width="78" height="24" viewBox="0 0 78 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_5187_28413)">
                    <path d="M3.29742 24.0003H62.1243C66.5002 24.0003 71.4968 22.4071 74.3767 14.1688L77.3538 5.9619C78.452 3.05452 77.2072 0.601491 74.8643 0.507812H16.0388C11.6635 0.507812 6.66697 2.10101 3.78709 10.3387L0.808595 18.5462C-0.289597 21.4536 0.955154 23.9066 3.29742 24.0003Z" fill="#00ABEE"/>
                    <path d="M21.7307 16.2167C21.6448 16.2182 21.56 16.2371 21.4817 16.2723C21.4034 16.3075 21.3332 16.3583 21.2755 16.4214C20.4894 17.1575 19.5195 17.7129 18.2957 17.7129C16.0615 17.7129 14.3642 15.8881 14.3642 13.5924V13.5515C14.3642 11.2765 16.0196 9.45178 18.1923 9.45178C19.4756 9.45178 20.3441 10.0252 21.11 10.7231C21.2561 10.8415 21.4387 10.9067 21.6274 10.9078C21.728 10.9079 21.8276 10.8883 21.9205 10.8502C22.0134 10.8121 22.0978 10.7562 22.1689 10.6857C22.24 10.6152 22.2964 10.5315 22.3347 10.4394C22.3731 10.3473 22.3928 10.2487 22.3926 10.149C22.3929 10.0446 22.3709 9.94137 22.328 9.84601C22.2852 9.75064 22.2225 9.66532 22.1441 9.59564C21.1924 8.73447 19.9923 8.05664 18.2133 8.05664C15.0889 8.05664 12.7297 10.5993 12.7297 13.5917V13.6325C12.7297 16.6055 15.0889 19.1267 18.2133 19.1267C20.0132 19.1267 21.2343 18.4295 22.2481 17.4251C22.3783 17.2936 22.4523 17.1175 22.4547 16.9333C22.4488 16.745 22.3706 16.566 22.2361 16.4329C22.1015 16.2997 21.9208 16.2224 21.7307 16.2167Z" fill="white"/>
                    <path d="M26.1384 3.8125C25.9272 3.81707 25.7263 3.90391 25.5793 4.05421C25.4323 4.20451 25.3509 4.40616 25.3529 4.61546V18.1827C25.3508 18.2884 25.3702 18.3934 25.41 18.4915C25.4497 18.5896 25.509 18.6788 25.5842 18.7537C25.6595 18.8286 25.7492 18.8878 25.848 18.9277C25.9468 18.9675 26.0527 18.9872 26.1594 18.9857C26.6146 18.9857 26.9455 18.6371 26.9455 18.1827V4.61211C26.9446 4.40031 26.8593 4.19744 26.7081 4.04767C26.557 3.89791 26.3522 3.81338 26.1384 3.8125Z" fill="white"/>
                    <path d="M31.5801 4.11914C31.0628 4.11914 30.6494 4.44701 30.6494 4.95957V5.22722C30.6494 5.71903 31.0628 6.06765 31.5801 6.06765C32.1204 6.06765 32.5324 5.71903 32.5324 5.22722V4.95957C32.5324 4.44701 32.1184 4.11914 31.5801 4.11914Z" fill="white"/>
                    <path d="M31.5802 8.17983C31.369 8.18457 31.1682 8.27144 31.0211 8.42168C30.874 8.57193 30.7924 8.77348 30.7941 8.98278V18.184C30.7921 18.29 30.8117 18.3953 30.8517 18.4936C30.8917 18.5919 30.9513 18.6813 31.027 18.7562C31.1026 18.8312 31.1928 18.8903 31.292 18.9299C31.3913 18.9695 31.4976 18.9889 31.6046 18.987C32.0598 18.987 32.3907 18.6383 32.3907 18.184V8.97944C32.3923 8.87372 32.3724 8.76877 32.3321 8.67084C32.2919 8.57291 32.2322 8.484 32.1566 8.40939C32.081 8.33479 31.991 8.27602 31.892 8.23658C31.793 8.19714 31.6869 8.17784 31.5802 8.17983Z" fill="white"/>
                    <path d="M41.3468 8.05664C39.505 8.05664 38.3879 8.97937 37.6842 10.1309V8.97937C37.6862 8.87338 37.6666 8.76807 37.6266 8.66975C37.5866 8.57142 37.527 8.48211 37.4513 8.40715C37.3756 8.33218 37.2855 8.27311 37.1862 8.23346C37.087 8.19382 36.9807 8.17442 36.8737 8.17642C36.6625 8.18116 36.4616 8.26803 36.3145 8.41827C36.1674 8.56852 36.0859 8.77007 36.0875 8.97937V18.1839C36.0855 18.2896 36.105 18.3947 36.1448 18.4928C36.1846 18.5909 36.244 18.68 36.3193 18.7549C36.3946 18.8299 36.4843 18.889 36.5832 18.9288C36.682 18.9687 36.7879 18.9884 36.8946 18.9869C37.3499 18.9869 37.6808 18.6383 37.6808 18.1839V12.8128C37.6808 10.8242 39.0465 9.49193 40.8883 9.49193C42.7706 9.49193 43.8472 10.7218 43.8472 12.6897V18.1839C43.8472 18.3932 43.9311 18.5938 44.0804 18.7418C44.2297 18.8897 44.4323 18.9728 44.6435 18.9728C44.8546 18.9728 45.0572 18.8897 45.2065 18.7418C45.3558 18.5938 45.4397 18.3932 45.4397 18.1839V12.3003C45.4431 9.77898 43.9323 8.05664 41.3468 8.05664Z" fill="white"/>
                    <path d="M49.7686 4.11914C49.2519 4.11914 48.8379 4.44701 48.8379 4.95957V5.22722C48.8379 5.71903 49.2519 6.06765 49.7686 6.06765C50.3089 6.06765 50.7209 5.71903 50.7209 5.22722V4.95957C50.7209 4.44701 50.3069 4.11914 49.7686 4.11914Z" fill="white"/>
                    <path d="M49.7683 8.17978C49.5571 8.18452 49.3564 8.27142 49.2094 8.42168C49.0624 8.57194 48.981 8.77349 48.9828 8.98274V18.1839C48.9807 18.2896 49.0001 18.3946 49.0398 18.4927C49.0796 18.5908 49.1388 18.68 49.2141 18.7549C49.2893 18.8298 49.379 18.889 49.4779 18.9289C49.5767 18.9687 49.6826 18.9885 49.7892 18.9869C50.2445 18.9869 50.5754 18.6383 50.5754 18.1839V8.97939C50.577 8.87394 50.5573 8.76923 50.5173 8.67148C50.4773 8.57373 50.4179 8.48494 50.3427 8.41036C50.2674 8.33578 50.1778 8.27695 50.0791 8.23734C49.9804 8.19773 49.8747 8.17816 49.7683 8.17978Z" fill="white"/>
                    <path d="M62.8435 17.6718L59.3673 13.4489L62.6983 9.41002C62.8295 9.27071 62.9034 9.08794 62.9057 8.89747C62.908 8.80264 62.8908 8.70834 62.8553 8.62028C62.8197 8.53221 62.7665 8.45222 62.6988 8.38515C62.6311 8.31808 62.5503 8.26533 62.4614 8.23009C62.3725 8.19485 62.2774 8.17787 62.1816 8.18016C61.8919 8.18016 61.6846 8.3441 61.4981 8.56959L58.4359 12.4238L55.3527 8.54952C55.167 8.32402 54.9597 8.18016 54.6497 8.18016C54.5511 8.1766 54.4529 8.1932 54.3611 8.22893C54.2694 8.26466 54.186 8.31875 54.1163 8.38782C54.0466 8.45689 53.992 8.53946 53.9559 8.63037C53.9199 8.72128 53.9031 8.81859 53.9067 8.9162C53.9067 9.12163 53.9891 9.30563 54.1553 9.49031L57.4451 13.4877L53.9486 17.7561C53.88 17.8225 53.8262 17.9024 53.7906 17.9907C53.755 18.079 53.7384 18.1736 53.7419 18.2686C53.7416 18.363 53.7603 18.4566 53.7968 18.5438C53.8333 18.631 53.8869 18.7102 53.9545 18.7767C54.0221 18.8432 54.1023 18.8958 54.1906 18.9314C54.2788 18.967 54.3734 18.9848 54.4686 18.9839C54.7584 18.9839 54.9651 18.82 55.1515 18.5938L58.3792 14.5349L61.6278 18.6166C61.8142 18.8421 62.0209 18.9859 62.3316 18.9859C62.4297 18.9878 62.5271 18.97 62.6181 18.9336C62.709 18.8973 62.7917 18.8431 62.861 18.7744C62.9304 18.7057 62.985 18.6238 63.0217 18.5337C63.0584 18.4436 63.0764 18.3471 63.0745 18.2499C63.0739 18.0405 62.9908 17.8565 62.8435 17.6718Z" fill="white"/>
                </g>
                <defs>
                    <clipPath id="clip0_5187_28413">
                        <rect width="78" height="24" fill="white"/>
                    </clipPath>
                </defs>
            </svg>',
            
            'calendar_icon' => '<svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 60C10 41.1438 10 31.7157 15.8579 25.8579C21.7157 20 31.1438 20 50 20H70C88.8562 20 98.2843 20 104.142 25.8579C110 31.7157 110 41.1438 110 60V70C110 88.8562 110 98.2843 104.142 104.142C98.2843 110 88.8562 110 70 110H50C31.1438 110 21.7157 110 15.8579 104.142C10 98.2843 10 88.8562 10 70V60Z" stroke="#00A3A3" stroke-width="2"/>
                <path d="M35 20V12.5" stroke="#00A3A3" stroke-width="2" stroke-linecap="round"/>
                <path d="M85 20V12.5" stroke="#00A3A3" stroke-width="2" stroke-linecap="round"/>
                <path d="M12.5 45H107.5" stroke="#00A3A3" stroke-width="2" stroke-linecap="round"/>
                <path d="M90 85C90 87.7614 87.7614 90 85 90C82.2386 90 80 87.7614 80 85C80 82.2386 82.2386 80 85 80C87.7614 80 90 82.2386 90 85Z" fill="#00A3A3"/>
                <path d="M90 65C90 67.7614 87.7614 70 85 70C82.2386 70 80 67.7614 80 65C80 62.2386 82.2386 60 85 60C87.7614 60 90 62.2386 90 65Z" fill="#00A3A3"/>
                <path d="M65 85C65 87.7614 62.7614 90 60 90C57.2386 90 55 87.7614 55 85C55 82.2386 57.2386 80 60 80C62.7614 80 65 82.2386 65 85Z" fill="#00A3A3"/>
                <path d="M65 65C65 67.7614 62.7614 70 60 70C57.2386 70 55 67.7614 55 65C55 62.2386 57.2386 60 60 60C62.7614 60 65 62.2386 65 65Z" fill="#00A3A3"/>
                <path d="M40 85C40 87.7614 37.7614 90 35 90C32.2386 90 30 87.7614 30 85C30 82.2386 32.2386 80 35 80C37.7614 80 40 82.2386 40 85Z" fill="#00A3A3"/>
                <path d="M40 65C40 67.7614 37.7614 70 35 70C32.2386 70 30 67.7614 30 65C30 62.2386 32.2386 60 35 60C37.7614 60 40 62.2386 40 65Z" fill="#00A3A3"/>
            </svg>',
            
            'trash_icon' => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.64258 3.33268C7.98578 2.36169 8.91181 1.66602 10.0003 1.66602C11.0888 1.66602 12.0149 2.36169 12.3581 3.33268" stroke="#F53636" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M17.0837 5H2.91699" stroke="#F53636" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M15.6946 7.08398L15.3113 12.8332C15.1638 15.0457 15.09 16.1519 14.3692 16.8263C13.6483 17.5007 12.5397 17.5007 10.3223 17.5007H9.67787C7.46054 17.5007 6.35187 17.5007 5.63103 16.8263C4.91019 16.1519 4.83644 15.0457 4.68895 12.8332L4.30566 7.08398" stroke="#F53636" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M7.91699 9.16602L8.33366 13.3327" stroke="#F53636" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M12.0837 9.16602L11.667 13.3327" stroke="#F53636" stroke-width="1.5" stroke-linecap="round"/>
            </svg>',
            
            'checkbox_checked' => '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10 20C5.28595 20 2.92893 20 1.46447 18.5355C0 17.0711 0 14.714 0 10C0 5.28595 0 2.92893 1.46447 1.46447C2.92893 0 5.28595 0 10 0C14.714 0 17.0711 0 18.5355 1.46447C20 2.92893 20 5.28595 20 10C20 14.714 20 17.0711 18.5355 18.5355C17.0711 20 14.714 20 10 20ZM14.0303 6.96967C14.3232 7.26256 14.3232 7.73744 14.0303 8.03033L9.03033 13.0303C8.73744 13.3232 8.26256 13.3232 7.96967 13.0303L5.96967 11.0303C5.67678 10.7374 5.67678 10.2626 5.96967 9.96967C6.26256 9.67678 6.73744 9.67678 7.03033 9.96967L8.5 11.4393L12.9697 6.96967C13.2626 6.67678 13.7374 6.67678 14.0303 6.96967Z" fill="#D82466"/>
            </svg>',
            
            'checkbox_unchecked' => '<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.75 10.75C0.75 6.03595 0.75 3.67893 2.21447 2.21447C3.67893 0.75 6.03595 0.75 10.75 0.75C15.464 0.75 17.8211 0.75 19.2855 2.21447C20.75 3.67893 20.75 6.03595 20.75 10.75C20.75 15.464 20.75 17.8211 19.2855 19.2855C17.8211 20.75 15.464 20.75 10.75 20.75C6.03595 20.75 3.67893 20.75 2.21447 19.2855C0.75 17.8211 0.75 15.464 0.75 10.75Z" stroke="#EAEDF0" stroke-width="1.5"/>
            </svg>'
        );
    }
    
    /**
     * Get days of week array
     * 
     * @return array Days of week
     */
    public static function get_days_of_week() {
        return array(
            'sunday' => 'יום ראשון',
            'monday' => 'יום שני',
            'tuesday' => 'יום שלישי',
            'wednesday' => 'יום רביעי',
            'thursday' => 'יום חמישי',
            'friday' => 'יום שישי',
            'saturday' => 'יום שבת'
        );
    }
    
    /**
     * Validate schedule data
     * 
     * @param array $data Schedule data
     * @return bool|WP_Error True if valid, WP_Error if not
     */
    public static function validate_schedule_data($data) {
        if (empty($data['days']) || !is_array($data['days'])) {
            return new WP_Error('no_days', 'No working days provided');
        }
        
        if (empty($data['treatments']) || !is_array($data['treatments'])) {
            return new WP_Error('no_treatments', 'No treatments provided');
        }
        
        return true;
    }
}

